<!-- ===== BOOTSTRAP CSS ===== -->
<link href="assets/libs/bootstrap.min.css" rel="stylesheet">

<style>
/* --- FIXED CHECKOUT BUTTON --- */
.btn-checkout {
  padding: 8px 12px;
  background: #1e88e5;
  color: #fff;
  border: none;
  cursor: pointer;
  border-radius: 8px;
  position: fixed;
  bottom: 20px;
  right: 15px;
  z-index: 99999;
  font-weight: 600;
  transition: 0.3s;
}

.btn-checkout span { margin-left: 5px; }
.btn-checkout:hover { background: #1565c0; }
@media (max-width: 768px) { .btn-checkout span { display:none; } }

/* --- OVERLAY --- */
.checkout-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
  z-index: 999;
}
.checkout-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

/* --- MODAL BASE --- */
.checkout-modal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  width: 90%;
  max-width: 400px;
  background: #1f1f2e;
  color: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 5px 30px rgba(0,0,0,0.6);
  opacity: 0;
  pointer-events: none;
  z-index: 1000;
  transition: transform 0.25s ease, opacity 0.25s ease;
}
.checkout-modal.show {
  opacity: 1;
  pointer-events: auto;
  transform: translate(-50%, -50%) scale(1);
}

.checkout-header { display: flex; justify-content: space-between; align-items: center; margin-top: -10px; }
.checkout-header h3 { margin: 0; font-size: 16px; }
.close-btn { font-size: 22px; cursor: pointer; }

.checkout-body { margin-top: 15px; display: flex; flex-direction: column; gap: 12px; }
.checkout-body input,
.checkout-body select {
  padding: 10px;
  width: 100%;
  border: 1px solid #444;
  border-radius: 6px;
  background: #2a2a3d;
  color: #fff;
  outline: none;
  text-align: center;
}
#customAmount { display: none; }

.btn-submit {
  width: 100%;
  padding: 12px;
  background: #1976d2;
  color: #fff;
  border: none; 
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}
.btn-submit:hover { background: #115293; }
</style>

<!-- ===== CHECKOUT BUTTON ===== -->
<button id="checkoutBtn" class="btn-checkout">
    ðŸ’³ <span>Buy Me Coffee</span>
</button>

<!-- ===== OVERLAY ===== -->
<div id="checkoutOverlay" class="checkout-overlay"></div>

<!-- ===== DONATION MODAL ===== -->
<div id="checkoutModal" class="checkout-modal">
  <div class="checkout-header">
    <h3>Donate</h3>
    <span id="closeModal" class="close-btn">&times;</span>
  </div>

  <div class="checkout-body">
    <label>Donation Amount</label>
    <select id="amountSelect" class="form-select">
      <option value="10">R 10</option>
      <option value="20">R 20</option>
      <option value="50">R 50</option>
      <option value="100">R 100</option>
      <option value="200">R 200</option>
      <option value="other">Other Amount</option>
    </select>

    <input type="number" id="customAmount" placeholder="Enter custom amount" min="1">
    <button class="btn-submit" id="payBtn">Pay Now</button>
  </div>
</div>

<script src="assets/libs/bootstrap.bundle.min.js"></script>
<script>
const modal = document.getElementById("checkoutModal");
const overlay = document.getElementById("checkoutOverlay");
const openBtn = document.getElementById("checkoutBtn");
const closeBtn = document.getElementById("closeModal");

const amountSelect = document.getElementById("amountSelect");
const customAmountInput = document.getElementById("customAmount");
const payBtn = document.getElementById("payBtn");

/* --- OPEN/CLOSE MODAL --- */
openBtn.addEventListener("click", () => { modal.classList.add("show"); overlay.classList.add("show"); });
closeBtn.addEventListener("click", closeModal);
overlay.addEventListener("click", closeModal);

function closeModal() { modal.classList.remove("show"); overlay.classList.remove("show"); }

/* --- SHOW CUSTOM AMOUNT INPUT --- */
amountSelect.addEventListener("change", () => {
  customAmountInput.style.display = amountSelect.value === "other" ? "block" : "none";
});

/* --- PAY BUTTON --- */
payBtn.addEventListener("click", async () => {
  let amount = amountSelect.value === "other"
    ? parseFloat(customAmountInput.value)
    : parseFloat(amountSelect.value);

  if (isNaN(amount) || amount <= 0) {
    alert('Please enter a valid donation amount.');
    return;
  }

  try {
    const val = Math.round(amount * 100); // cents
    const api = "https://tevrocsoft-api.vercel.app";

    const response = await fetch(`${api}/create-checkout?amount=${val}`, { method: "POST" });
    const data = await response.json();

    if (data.checkoutId && data.redirectUrl) {
      // Reload page with query params
      const newUrl = `${window.location.origin}${window.location.pathname}?checkoutId=${data.checkoutId}&redirectUrl=${encodeURIComponent(data.redirectUrl)}`;
      window.location.href = newUrl;
    } else {
      alert("Failed to create checkout.");
      console.error(data);
    }

  } catch (err) {
    console.error(err);
    alert("Error creating checkout. Check console.");
  }
});

/* --- OPEN POPUP ON PAGE LOAD IF QUERY PARAMS EXIST --- */
window.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const checkoutId = params.get("checkoutId");
  const redirectUrl = params.get("redirectUrl");

  if (checkoutId && redirectUrl) {
    // Open Yoco popup
    window.open(redirectUrl, "_blank", "width=500,height=700");

    // Optional: remove query params so refresh doesn't reopen
    const cleanUrl = `${window.location.origin}${window.location.pathname}`;
    window.history.replaceState({}, document.title, cleanUrl);
  }
});
</script>
