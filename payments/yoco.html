<!-- Bootstrap CSS -->
<link href="assets/libs/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS -->
<script src="assets/libs/bootstrap.bundle.min.js"></script>

<style>
/* === CHECKOUT BUTTON FIXED === */
.btn-checkout {
  padding: 6px 10px;
  background: #1e88e5;
  color: #fff;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  position: fixed;
  bottom: 20px;
  right: 10px;
  z-index: 99999;
  font-weight: 600;
  transition: 0.3s;
}

@media (max-width: 768px) { .btn-checkout span { display:none; }}
@media (max-width: 480px) { .btn-checkout span { display:none; }}

.btn-checkout:hover {
  background: #1565c0;
}

/* === OVERLAY === */
.checkout-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  z-index: 999;
}

/* === MODAL === */
.checkout-modal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  width: 380px;
  background: #1f1f2e;
  color: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 5px 30px rgba(0,0,0,0.6);
  display: none;
  z-index: 1000;
  transition: transform 0.25s ease, opacity 0.25s ease;
  opacity: 0;
}

.checkout-modal.show {
  display: block;
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

/* === HEADER === */
.checkout-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top:-10px;
}

.checkout-header h3 {
  margin: 0;
  font-size: 16px;
}

.close-btn {
  font-size: 22px;
  cursor: pointer;
}

/* === BODY === */
.checkout-body {
  margin-top: 15px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.checkout-body input,
.checkout-body select {
  padding: 10px;
  width: 100%;
  border: 1px solid #444;
  border-radius: 6px;
  background: #2a2a3d;
  color: #fff;
  outline: none;
  text-align: center;
}

#customAmount { display: none; }

.btn-submit {
  width: 100%;
  padding: 12px;
  background: #1976d2;
  color: #fff;
  border: none; 
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}

.btn-submit:hover {
  background: #115293;
}

/* Show overlay */
.checkout-overlay.show { display: block; }

/* === IFRAME MODAL === */
#iframeModal {
  width: 90%;
  max-width: 600px;
  height: 80%;
  padding: 0;
}

#iframeModal iframe {
  width: 100%;
  height: calc(100% - 50px);
  border: none;
  border-radius: 0 0 12px 12px;
}

#iframeModal.show {
  display: block;
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}
</style>

<!-- Checkout Button (Fixed) -->
<button id="checkoutBtn" class="btn-checkout">
    ðŸ’³ <span> Buy Me Coffe</span> 
</button>

<!-- Overlay -->
<div id="checkoutOverlay" class="checkout-overlay"></div>

<!-- Amount Selection Modal -->
<div id="checkoutModal" class="checkout-modal">
  <div class="checkout-header">
    <h3>Donate</h3>
    <span id="closeModal" class="close-btn">&times;</span>
  </div>

  <div class="checkout-body">
    <label>Donation Amount</label>
    <select id="amountSelect" class="form-select">
      <option value="10">R 10</option>
      <option value="20">R 20</option>
      <option value="50">R 50</option>
      <option value="100">R 100</option>
      <option value="200">R 200</option>
      <option value="other">Other Amount</option>
    </select>

    <input type="number" id="customAmount" placeholder="Enter custom amount" min="1">

    <button class="btn-submit" id="payBtn">Pay Now</button>
  </div>
</div>

<!-- IFRAME CHECKOUT MODAL -->
<div id="iframeModal" class="checkout-modal">
  <div class="checkout-header" style="padding:10px;">
    <h3>Secure Payment</h3>
    <span id="closeIframeModal" class="close-btn">&times;</span>
  </div>

  <iframe id="checkoutFrame"></iframe>
</div>

<script>
const modal = document.getElementById("checkoutModal");
const overlay = document.getElementById("checkoutOverlay");
const openBtn = document.getElementById("checkoutBtn");
const closeBtn = document.getElementById("closeModal");

const iframeModal = document.getElementById("iframeModal");
const closeIframeBtn = document.getElementById("closeIframeModal");
const checkoutFrame = document.getElementById("checkoutFrame");

const amountSelect = document.getElementById("amountSelect");
const customAmountInput = document.getElementById("customAmount");
const payBtn = document.getElementById("payBtn");

/* ---- OPEN / CLOSE MAIN MODAL ---- */
openBtn.onclick = () => {
  modal.classList.add("show");
  overlay.classList.add("show");
};

closeBtn.onclick = closeModal;
overlay.onclick = () => { closeModal(); closeIframe(); };

function closeModal() {
  modal.classList.remove("show");
}

function closeIframe() {
  iframeModal.classList.remove("show");
  checkoutFrame.src = ""; // clear iframe
  overlay.classList.remove("show");
}

/* ---- SHOW CUSTOM AMOUNT ---- */
amountSelect.addEventListener("change", function () {
  customAmountInput.style.display = this.value === "other" ? "block" : "none";
});

/* ---- CREATE YOCO CHECKOUT ---- */
payBtn.addEventListener('click', async () => {
  let amount = amountSelect.value === "other"
    ? parseFloat(customAmountInput.value)
    : parseFloat(amountSelect.value);

  if (isNaN(amount) || amount <= 0) {
    alert('Please enter a valid donation amount.');
    return;
  }

  try {
    const val = Math.round(amount * 100);
    console.log("Amount in cents:", val);

    //let url = 'http://localhost:3008';
    let url = 'https://tevrocsoft-api.vercel.app';

    const response = await fetch(`${url}/create-checkout?amount=${val}`, {
      method: 'POST'
    });

    const data = await response.json();

    if (data.redirectUrl) {
      // Load inside iframe instead of redirect
      checkoutFrame.src = data.redirectUrl;

      // Close amount modal
      closeModal();

      // Open iframe modal
      iframeModal.classList.add("show");
      overlay.classList.add("show");
    } else {
      alert('Failed to create checkout.');
      console.error(data);
    }
  } catch (error) {
    console.error(error);
    alert('Error creating checkout. See console for details.');
  }
});

closeIframeBtn.onclick = closeIframe;
</script>
