<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8" /> 
    <link rel="icon" href="logo.ico" type="image/x-icon">
    <title>Zoom Meeting SDK Sample</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }

        /* Zoom container */
        #zmmtg-root {
            width: 100%;
            height: 80vh;
        }
    </style>
</head>
<body class="p-4">

    <div class="container mt-4">
        <h3 class="mb-3">Join a Zoom Meeting</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#joinModal">Join Meeting</button>
    </div>

    <!-- Modal form to enter meeting ID/password -->
    <div class="modal fade" id="joinModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enter Meeting Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="joinForm">
                        <div class="mb-3">
                            <label class="form-label">Meeting ID</label>
                            <input type="text" class="form-control" id="meetingId" placeholder="Enter Meeting ID" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="userName" placeholder="Enter Username">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password (optional)</label>
                            <input type="text" class="form-control" id="meetingPass" placeholder="Enter Password">
                        </div>
                        <button type="submit" class="btn btn-success w-100">Join</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal to show Zoom SDK -->
    <div class="modal fade" id="zoomModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Zoom Meeting</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="zmmtg-root"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Zoom SDK dependencies -->
    <script src="https://source.zoom.us/4.0.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/4.0.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/4.0.0/lib/vendor/redux.min.js"></script>
    <script src="https://source.zoom.us/4.0.0/lib/vendor/redux-thunk.min.js"></script>
    <script src="https://source.zoom.us/4.0.0/lib/vendor/lodash.min.js"></script>
    <script src="https://source.zoom.us/4.0.0/zoom-meeting-4.0.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        ZoomMtg.preLoadWasm();
        ZoomMtg.prepareWebSDK();

        const joinForm = document.getElementById('joinForm');
        const zoomModalEl = document.getElementById('zoomModal');
        const zoomModal = new bootstrap.Modal(zoomModalEl);

        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const meetingNumber = document.getElementById('meetingId').value.trim();
            const passWord = document.getElementById('meetingPass').value.trim();
            const userName = document.getElementById('userName').value.trim() || 'Guest';

            if (!meetingNumber) return alert('Please enter a Meeting ID');

            try {
                // 1️⃣ Request signature & SDK Key from backend
                const res = await fetch('https://tevrocsoft-api.netlify.app/.netlify/functions/zoom-signature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ meetingNumber, role: 0 }) // 0 = attendee
                });
                const data = await res.json();
                if (!data.signature || !data.sdkKey) throw new Error('Invalid signature from server');

                const signature = data.signature;
                const sdkKey = data.sdkKey;

                // 2️⃣ Show Zoom modal
                zoomModal.show();

                // 3️⃣ Initialize Zoom after modal is visible
                zoomModalEl.addEventListener('shown.bs.modal', () => {
                    ZoomMtg.init({
                        leaveUrl: window.location.href,
                        disablePreview: false,
                        isSupportAV: true,
                        success: () => {
                            ZoomMtg.join({
                                signature,
                                sdkKey,
                                meetingNumber,
                                passWord,
                                userName,
                                userEmail: '',
                                success: () => console.log('Joined meeting'),
                                error: (err) => console.error('Join error:', err)
                            });
                        },
                        error: (err) => console.error('Init error:', err)
                    });
                }, { once: true });

            } catch (err) {
                alert('Error joining meeting: ' + err.message);
                console.error(err);
            }
        });
    </script>

</body>
</html>
